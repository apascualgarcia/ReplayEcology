

## README


This repository contains scripts and data to reproduce results of the [article](https://doi.org/10.1101/2023.07.07.548163):

```
Pascual-García, A., Rivett, D., Jones, M. L., & Bell, T. (2023). Replaying the tape of ecology to domesticate wild microbiomes. bioRxiv, 2023-07. (https://doi.org/10.1101/2023.07.07.548163)
```

### Organization of the repository

#### Folders
The repository has a folder containing all the scripts (`src`) and several folders for the data. It is necessary to keep this structure to execute the scripts. Folders labelled 1 to 6 are used sequentially for dada2 pipeline, with final ASV tables available in folder number 6. Folders labelled 7 contain analysis related to microbial composition. Folder 8 contains PICRUSt analysis and folder 9 the predictions obtained after optimal superposition.

#### Files excluded

To keep the repository as light as possible, a number of files were excluded. These files can be regenerated using the scripts provided.

* Folders 1 to 3 are completely empty because they should contain the raw sequencing data and a number of large output files from dada2. 
* The following files are also excluded (included in `.gitignore`):
    * `dada_output.RDS`, `seqtab.csv` and `seqtab.nochim.csv`.
    * `silva*`.
    * `4_dada2/DECIPHER_2.20.0`
    * `5_treeholes/seqtab_treeholes.csv`
    * `8_PICRUSt2/KO_metagenome_out/pred_metagenome_unstrat.tsv` (A bzip2 compressed file with the same name is available)
    * Intermediate files generated by PICRUSt (`8_PiCRUST/intermediate`).
    * All figures (extension `*pdf`).

### Input data

* Sequences associated with this study are deposited at NCBI under BioProject accession number PRJNA989519. This project contains the 16S rRNA amplicon sequencing data associated with each of the communities at day 0
(SUB13586664), as well as at day 7 for the four replicate growth experiments (SUB13586665-8). 

* Users interested in reproducing the whole pipeline should **details in progress**.

* Users interested in the processed data will find: 
    * `seqtable_readyforanalysis.csv`: ASV vs samples table, found in directory `6_finalfiles`.
    * `metadata_Time0D-7D-4M_May2022.csv`: starting metadata table, found in directory `4_dada2`. During the analysis, this table will be extended. Therefore, other metadata tables can be found in subsequent folders.
    * `taxa_wsp_readyforanalysis.csv`: Taxonomy, also found in directory `6_finalfiles`.
    
    
#### Description metadata table

The most comprehensive metadata table possibly is `metadata_Time0D-7D-4M_May2022_wJSDpart_ext.csv`, located in the directory `7.3_phyloseq/`. Please note that this metadata contains information of samples used in experiments related to these communities but not presented in this work. In addition, all starting communities presented in Pascual-García & Bell, _Nature Commun._ 2020 are also available in this repository, although only a subset of them were revived for this work. We describe below how to identify this subset.

Metadata contain the following fields:

* `sampleid`: Id of samples
* `Name.2`: Alternative Id for some samples **(not used in this work)**
* `Community`: **Ignore, not used in this work.**
* `Species`: **Ignore, not used in this work.**
* `replicate`: Replicate of the experiment. Starting communities are labelled as Rep0
* `BreakingBag`: **Ignore, not used in this work.**
* `parent`: ID of the starting communities from which final communities departed. For example, final community with id `WYT14.1` is the replicate 1 of starting community `WYT14`, which is the ID indicated in this field. 
* `Location`: Sampling field from which the starting communities were sampled.
* `Experiment`: Either starting communities (`0D`) or final communities (`7D_rep$`) were "$" = 1-4 depending on the replicate. **Samples belonging to experiment `4M` should be ignored.**
* `Part_Time0D_17`: Id of the class the starting communities belong to, corresponding to the maximum of the Calinski-Harabasz index found considering starting communities only. (1 to 17 and NA for samples not belonging to the set)
* `Part_Time0D_6`:  Id of the class the starting communities belong to, corresponding to the second maximum of the Calinski-Harabasz index found considering starting communities only (analysed in this work) (runs from 1 to 6 and NA for samples not belonging to the set)
* `Part_Time4M_64`:  **Ignore, not used in this work.**
* `Part_Time7D_rep1_2`: Id of the class the first replicate of final communities belong to, corresponding to the maximum of the Calinski-Harabasz index.  (1 to 2 and NA for samples not belonging to the set)
* `Part_Time7D_rep2_2`:  Id of the class the second replicate of final communities belong to, corresponding to the maximum of the Calinski-Harabasz index. (1 to 2 and NA for samples not belonging to the set)
* `Part_Time7D_rep3_2`:  Id of the class the third replicate of final communities belong to, corresponding to the maximum of the Calinski-Harabasz index. (1 to 2 and NA for samples not belonging to the set)
* `Part_Time7D_rep4_2`:  Id of the class the fourth replicate of final communities belong to, corresponding to the maximum of the Calinski-Harabasz index. (1 to 2 and NA for samples not belonging to the set)
* `replicate.partition`: Combination of the replicate and partition ids. Note that the ids obtained for each replicate independently (1 and 2 for each replicate) can be considered paired across replicates, since we showed they have similar compositions. Also note that Rep0.Class1 and Rep0.Class2 are ids used in Experiments `0D` and `4M`. Therefore, those belonging to `Experiment = 4M` should be ignored.
* `partition`: Only the class. As in the previous field, one should exclude samples in `Experiment = 4M`.
* `ExpCompact`: Another identifier for the experiment, in which the 4 replicates of final communities have the same id (note that in the field `Experiment` the different replicates were differentiated). Levels are `Starting`, `Final` (and `Evolved` should be excluded).
* `exp.replicate.partition`: Combination of `ExpCompact`, and `replicate.partition`
* `exp.partition`: Combination of `ExpCompact`, and `partition`




### Scripts

Most scripts have a header describing their usage. All of them were coded considering the structure of the repository, so there is no need to modify the paths, hence are hard-coded relative to the root of the repository. Please note that to make the scripts portable some functions to recover the user's path are used which, in the case of R scripts, require executing the script from Rstudio. Some scripts have different options for the analysis, indicated in variables. The main scripts are:

**dada2 details in progress**

* `main_find_classes.R` Computes the all-against-all JSD for all samples and looks for the optimal partition (output in `7.1_classes`).
* `main_find_classes_exp-split.R` Same analysis for each experiment and replicate independently (output in `7.1_classes`).
* `merge_metadata.R` Script to merge metadata tables obtained with the previous scripts (output in `7.1_classes`).
* `compare_classes.R` Generates a heatmap of the mean beta-diversity of each class and cluster classes (output in `7.1_classes`).
* `match_classes.R` and `TraceSamples_fromPartTime0toPartTime7.pl` Performs statistics between starting and final classes (output in `7.2_match`).
* `match_clusters_time0to7_V2.R` Represent the above statistics (output in `7.2_match`).
* `phyloseq_analysis.R` Creates bar plots and some ordinations (output in `7.3_phyloseq`).
* `anosimlike_analysis.R` Provides a quantitative estimation of samples' similarity between the different categorical groups through the ANOSIM statistics (output in `7.4_variance`)
* `distance_to_attractor.R` Provides a quantitative estimation for the probability of having all replicates in the same class as a function of the distance to the nearest attractor of the final classes (output in `7.5_attractors`).
* `represent_attractors.R` Some visualizations of the results obtained with `distance_to_attractor.R` (output in `7.5_attractors`).
* `pathways_to_heatmap.R` Creates some plots of PICRUSt results (output in `8_PICRUSt`).
* `community_superposition.R` Looks for the optimal superposition between starting communities and one of the replicates, performs a prediction and compares with the remaining replicates (output in `9_predictions`).



